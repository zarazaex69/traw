name: Release Traw

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build Binaries
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: bun-linux-x64
            artifact: traw-linux-x64
          - os: macos-latest
            target: bun-darwin-x64
            artifact: traw-darwin-x64
          - os: macos-latest
            target: bun-darwin-arm64
            artifact: traw-darwin-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build binary
        run: |
          bun build src/cli/index.ts \
            --compile \
            --target=${{ matrix.target }} \
            --outfile=${{ matrix.artifact }} \
            --external=electron \
            --external=chromium-bidi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  publish-npm:
    name: Publish to NPM
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update package version
        run: |
          npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version --allow-same-version

      - name: Publish to NPM
        run: npm publish --access public || echo "NPM publish failed, skipping..."
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  release:
    name: Create Release
    needs: [build-binaries]
    if: always() && needs.build-binaries.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Prepare binaries
        run: |
          cd binaries
          chmod +x */traw-*
          for dir in */; do
            name=$(basename "$dir")
            mv "$dir/$name" "./$name"
          done
          ls -la

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Traw v${{ steps.version.outputs.VERSION }}
          body: |
            ## Traw v${{ steps.version.outputs.VERSION }}

            AI browser agent for terminal.

            ---

            ### üì¶ Installation

            #### Option 1: Download Binary (no dependencies!)

            ```bash
            # Linux x64
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/traw-linux-x64 -o traw
            chmod +x traw
            sudo mv traw /usr/local/bin/

            # macOS Intel
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/traw-darwin-x64 -o traw
            chmod +x traw
            sudo mv traw /usr/local/bin/

            # macOS Apple Silicon
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/traw-darwin-arm64 -o traw
            chmod +x traw
            sudo mv traw /usr/local/bin/
            ```

            #### Option 2: NPM/Bun

            ```bash
            # npm global
            npm install -g traw

            # bun global
            bun add -g traw
            ```

            ---

            ### üöÄ Usage

            ```bash
            # basic search
            traw run "find weather in Moscow"

            # with options
            traw run "search for bun.js docs" --steps=30 --headed

            # help
            traw --help
            ```

            ---

            ### ‚ö†Ô∏è Requirements

            Binary requires Firefox browser installed:
            ```bash
            # after first run, install playwright firefox
            bunx playwright install firefox
            ```
          files: |
            binaries/traw-linux-x64
            binaries/traw-darwin-x64
            binaries/traw-darwin-arm64
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
